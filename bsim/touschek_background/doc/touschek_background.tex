\documentclass[11pt]{article}
\usepackage{tocloft}
\usepackage{geometry}            % See geometry.pdf to learn the layout options. There are lots.
\usepackage{xspace}
\geometry{letterpaper}           % ... or a4paper or a5paper or ... 
%\usepackage[parfill]{parskip}   % To begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{alltt}
\usepackage[T1]{fontenc}   % so _, <, and > print correctly in text.
\usepackage[strings]{underscore}    % to use "_" in text
\usepackage[pdftex,colorlinks=true,bookmarksnumbered=true]{hyperref}

%---------------------------------------------------------------------------------

\newcommand{\sref}[1]{$\S$\ref{#1}}
\newcommand\ttcmd{\begingroup\catcode`\_=11 \catcode`\%=11 \dottcmd}
\newcommand\dottcmd[1]{\texttt{#1}\endgroup}
\newcommand{\Begineq}{\begin{equation}}
\newcommand{\Endeq}{\end{equation}}
\newcommand{\fig}[1]{Figure~\ref{#1}}
\newcommand{\vn}{\ttcmd}           
\newcommand{\Th}{$^{th}$\xspace}
\newcommand{\Newline}{\hfil \\}


\newcommand{\bearray}{\begin{eqnarray}}
\newcommand{\eearray}{\end{eqnarray}}
\newcommand{\be}{\begin{equation}}
\newcommand{\ee}{\end{equation}}
\newcommand{\bearraynn}{\begin{eqnarray*}}
\newcommand{\eearraynn}{\end{eqnarray*}}
\newcommand{\benn}{\begin{displaymath}}
\newcommand{\eenn}{\end{displaymath}}
\newcommand{\eq}[1]{{Eq.~(\ref{#1})}}
\newcommand{\eqs}[2]{{Eqs.~(\ref{#1}--\ref{#2})}}

\newlength{\dPar}
\newlength{\ExBeg}
\newlength{\ExEnd}
\setlength{\dPar}{1.5ex}
\setlength{\ExBeg}{-\dPar}
\addtolength{\ExBeg}{-0.5ex}
\setlength{\ExEnd}{-\dPar}
\addtolength{\ExEnd}{-0.0ex}

\newenvironment{example}
  {\vspace{\ExBeg} \begin{alltt}}
  {\end{alltt} \vspace{\ExEnd}}

%---------------------------------------------------------------------------------

\setlength{\textwidth}{6.25in}
\setlength{\hoffset}{0.0in}
\setlength{\oddsidemargin}{0.0in}
\setlength{\evensidemargin}{0.0in}
\setlength{\textheight}{8.5in}
\setlength{\topmargin}{0in}

\setlength{\parskip}{\dPar}
\setlength{\parindent}{0ex}

\setlength\cftparskip{0pt}
\setlength\cftbeforesecskip{3pt}
\setlength\cftaftertoctitleskip{15pt}

%---------------------------------------------------------------------------------

\title{touschek_background Simulation Program}
\author{Michael Ehrlichman}

%---------------------------------------------------------------------------------

\begin{document}
\maketitle

%\pdfbookmark[1]{Contents}{Contents}
%\tableofcontents

%------------------------------------------------------------------
\section{Simulation Principle} 
\label{s:intro}

\vn{touschek_background} is a program for simulating where in an accelerator Touschek particles
are generted and where they are lost.
The source code for this program lives in the \vn{bsim} directory in
the standard Bmad\cite{b:bmad} distribution.

This program makes use of Piwinski's formula for the Touschek rate, which takes
the Twiss parameters and emittances at a particular element in the accelerator, along with a threshold momentum,
and returns the rate at which particles are scattered above that momentum\cite{ap:touschek}.
For a given threshold momentum $\delta_E$, the Touschek rate formula is evaluated twice,
once at $\delta_E$ and again at $\delta_E+\Delta\delta_E$.  The rate at which particles
are scattered into an energy window $\left[\delta_E,\delta_E+\Delta\delta_E\right]$
is,
\begin{equation}
R'\left[\delta_E\right]=\frac{R\left[\delta_E\right]-R\left[\delta_E+\Delta\delta_E\right]}
{\Delta\delta_E}
\label{eq:rate}
\end{equation}.

A test particle, starting on the nominal trajectory is given an energy kick $\delta_E$ and tracked
to where it is lost.  The rate from Eqn.~\ref{eq:rate} is recorded at that location.

The momentum aperture $\delta_{E,max}$ is the threshold energy kick above which a particle will be lost downstream
due to collision with the beam chamber.  The {\tt touschek_background} program divides the 
range $\left[\delta_{E,max},\infty\right]$ into a number of test particles.  The number of test particles
is a settable parameter.  An aperture file listing the locations and momentum aperture at
each element in the lattice is a required input for the {\tt touschek_background} program.  The aperture
file is typically generated by the {\tt aperture_by_tracking} program also located in {\tt bsim}.

So at every element in the lattice, several test particles are generated, each representing 
a different energy kick and rate.  These are tracked to where they are lost and the rate is accumulated
at the loss location.

The output of the {\tt touschek_background} program is the current and power of lost particles deposited
at each element in the lattice.

This simulation was originally developed to determine the best locations for collimators to 
intercept Touschek particles and control where losses occur.  To that end, particles lost to a collimator
are treated differently than particles lost elsewhere

Results from this simulation have been included in Refs.~\cite{mpe:coll}, \cite{mpe:esp}, \cite{mpe:thesis}.

\section{Input Parameters}
The input parameters are:
\begin{example}
\&parameters
  lat_file = <lattice file>
  aperture_file = <aperture_by_s.out generated by aperture_by_tracking>

	! Set region where particles are to be generated.
	! Can be set by location s or by element names.
  start_stop_type = 2 !1=by s, 2=by element name
  ! If "by s", then populate the s_prod_* and s_lost_* parameters.
  ! If "by element name", then populate the name_prod_* and 
  ! name_lost_* parameters

  ! s_prod_start = 839.2
  ! s_prod_end = 839.3  !a negative number here means lat%param%total_length
  name_prod_start = 'sa.mar.beg'
  name_prod_end   = 'sa.mar.end'

	! Set region where particles losses are to be recorded.
	! Losses before s_lost_start are ignored.
	! Particles are not tracked beyond s_lost_end.
  ! s_lost_start = 0.
  ! s_lost_end = 1219.6  !a negative number here means lat%param%total_length
  name_lost_start = 'sa.mar.beg'
  name_lost_end   = 'sa.mar.end'

  do_ibs = .false. !If true, then IBS will be taken into account when
                   !calculating the beam emittances and energy spread.
  count_col_losses = 1 ! 0=no, 1=non-zero-length only, 2 = yes

  ! emittances are set here.
  a_emittance = 3.0E-7
  b_emittance = 3.0E-7
  bunch_charge = 77.0E-12
  bunch_length = 6.0093947965E-04
  energy_spread_eV = 35.E3    !injected energy spread in eV
  test_collimator = 0.0025    !radius of test collimator used for potential 
                              ! collimator profile.
  collimate = .false.  !Add zero-length collimators according to collimators.in
                       !If this is true, then collimators.in must exist

  ! Set to true to record trajectories of lost particles.  This can be useful in 
  ! determining the best locations for collimator placement.
  traj_snapshot = .false.
  snapshot_start_slix = 316
  snapshot_stop_slix = 371
  ! Generate a histogram showing the current of test particles at each location
  ! in the lattice.
  histogram_orbit = .false.

  ! Number of test particles to generate at each element.
  N_test_part = 50
  !N_test_part = 1
  N_data_points = 8  ! number of samples of Touschek rate formula
  distParam = 0.9999 ! must be < 1.0, closer to 1 concentrates touschek 
                     ! sampling curve data points towards momentum aperture.  
                     ! 0.999 is good place to start
  ignore_thresh = 1.0E-5 !if a slice produced less than this rate of touschek 
                         !particles per bunch per meter,then it is skipped
&end
\end{example}

\section{Output Parameters}
Descriptions of output files generated by \vn{touschek_background}.

\subsection{\vn{collimator_profile.out}}
The \vn{.in} files contains a \vn{test_collimator} parameter that is a radius in units meters.
For each element between a location where a Touschek particle is generated and where it is lost,
the program tests if the Touschek particle trajectory exceeds \vn{test_collimator}.  If it does,
then the number of particles represented by the Touschek particle is added to running tally kept 
at that element.

This data can be used to determine where in the lattice a collimator should be placed so as to capture the most
Touschek particles.

Header:
\begin{verbatim}
#     slice   location   potential N    element name                           
#     index        (s)        caught                       
\end{verbatim}

\subsection{\vn{energy_deposited_at_s.out}}
Records the amount of energy deposited by Touschek particles colliding with the physical aperture
at each location.

This data can be used to determine radiation backgrounds.
Header: 
\begin{verbatim}
#      slice   location   nrg deposited at         cumulative
#      index        (m)    slice per bunch                nrg
#                                     (eV)               (eV)
\end{verbatim}

\subsection{\vn{generation_pipe.out}}
Records the number of Touschek particles generated at each location which are destined
to be lost to colliding with the beampipe, as opposed to those Touschek particles which
are lost due to stopping during deceleration.  This distinction is important for energy
recovery linacs.

Header:
\begin{verbatim}
#     slice   location    N generated   cumulative N
#     index        (s)       at slice      generated
\end{verbatim}

\subsection{\vn{generation_stop.out}}
Records the number of Touschek particles generated at each location which are destined
to be lost to stopping during deceleration, as opposed to those Touschek particles which
are lost due to colliding with the beampipe.  This distinction is important for energy
recovery linacs.

Header:
\begin{verbatim}
#     slice   location    N generated   cumulative N
#     index        (s)       at slice      generated
\end{verbatim}

\subsection{\vn{Npart_striking_pipe_by_s.out}}
Records the number of Touschek particles colliding with the beampipe at each location.

Header:
\begin{verbatim}
#      slice   location     N deposited at       cumulative N
#      index        (s)    slice per bunch                   
\end{verbatim}

\subsection{\vn{Npart_stopping_with_no_energy_by_s.out}}
Records the number of Touschek particles stopping at each slice due deceleration.

Header:
\begin{verbatim}
#      slice   location     N deposited at       cumulative N
#      index        (s)    slice per bunch                   
\end{verbatim}

\subsection{\vn{Npart_total_losses_by_s.out}}
Records the number of Touschek particles lost at each slice, counting
both those particles that stop due to deceleration and those that collide with the
beampipe.

Header:
\begin{verbatim}
#      slice   location     N deposited at       cumulative N
#      index        (s)    slice per bunch                   
\end{verbatim}

\subsection{\vn{physical_aperture_from_track.out}}
The physical apertures in the lattice that was tracked through.

Header:
\begin{verbatim}
#       ele     location     aperture   element name         
#     index          (s)       radius                 
\end{verbatim}

\subsection{\vn{raw_rates.out}}
This is the rate of Touschek particles scattered above the positive momentum aperture
and below the negative momentum aperture for each location in the lattice.
It is essentially, the Touschek formula evaluated at the given location
at the momentum aperture for that location.

Header:
\begin{verbatim}
#   slice    location     positive aperture     negative aperture
#   index         (s)    rate (N/bunch/sec)    rate (N/bunch/sec)
\end{verbatim}

\subsection{\vn{sigma_matrix.out}}
The matrix of second order moments of all the Touschek particles
passing through each location in the lattice.

Header:
\begin{verbatim}
# Slice     Location        Cov(x,x)       Cov(x,px)        Cov(x,y)   ...
# index            m             m^2               m             m^2   ...
#    row number:                   1               1               1   ...
# column number:                   1               2               3   ...
\end{verbatim}

\subsection{\vn{sigma_p.out}}
The energy spread at each location in the lattice after taking 
intrabeam scattering into account.

Header:
\begin{verbatim}
#  location       sigma_p    Total energy
#       (s)       (dp/p0)            (eV)
\end{verbatim}

\subsection{\vn{slice_index_from_track.out}}
The slice index assigned to each location in the lattice that was tracked
through.

Header:
\begin{verbatim}
#     slice      location   element
#     index           (s)   name
\end{verbatim}

\subsection{\vn{touschek_track.details}}
Compiled statistics from the Touschek tracking simulation.

\vn{Halo}: Was halo tracking enabled?\\
\vn{Number of data points:}  Number of samples of the Touschek formula per slice.\\
\vn{Number of test particles:}  Number of test particles used to represent the \\
distribution of Touschek particles at each slice.\\
\vn{Total Integrated current (\#e-):}  Total number of Touschek particles generated.\\
\vn{Beam Pipe Collisions:}  Total number of particles lost due to collision \\
with the physical aperture.\\
\vn{Zero Energy in Linac:}  Total number of particles lost due to stopping during \\
deceleration.\\
\vn{Energy deposited into beam pipe (eV):}  Total energy in eV deposited into the \\
beampipe due by Touschek particles.\\
\vn{Number of test particles:}  Total number of test particles generated \\
and tracked.\\
\vn{Number lost to beam pipe:}  Number of test particles lost to beam \\
pipe collisions.\\
\vn{Number lost to zero energy:}   Number of test particles stopped during \\
deceleration.\\

%------------------------------------------------------------------

\begin{thebibliography}{9}

\bibitem{b:bmad}
D. Sagan,
"Bmad: A Relativistic Charged Particle Simulation Library"
Nuc.\ Instrum.\ \& Methods Phys.\ Res.\ A, {\bf 558}, pp 356-59 (2006).
The Bmad web site:
\hfill\break
\hspace*{0.3in} \url{http://www.lepp.cornell.edu/~dcs/bmad}

\bibitem{ap:touschek}
Piwinski, A., ``The Touschek effect in strong focusing storage rings''.
https://arxiv.org/abs/physics/9903034
DESY 98-179.  1999.

\bibitem{mpe:coll}
Ehrlichman, M., Hoffstaetter, G.,
``Collimating Touschek Particles in an Energy Recovery Linear Accelerator''.
https://inspirehep.net/literature/1379047
PAC'09, Vancouver, Canada, 2009.

\bibitem{mpe:esp}
Hoffstaetter, G., Ehrlichman, M., Temnykh, A.
``Intra Beam Scattering in Linear Accelerators, Especially ERLs''.
https://accelconf.web.cern.ch/e08/papers/tupp040.pdf
EPAC'08, Genoa, Italy, 2008.

\bibitem{mpe:thesis}
Ehrlichman M.
``Normal Mode Analysis of Single Bunch, Charge Density Dependent Behavior in 
Electron/Positron Beams''.
https://www.classe.cornell.edu/~ehrlichm/Ehrlichman-Thesis-revised.pdf
Cornell University Graduate Thesis, Ithaca, New York, 2013.

\end{thebibliography}
\end{document}  
