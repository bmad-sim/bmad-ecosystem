#!/bin/bash
#
# NOTE: This script is dual-purpose and it's behvaior is determined by the
#       name of the symlink used to invoke it!
#
# Purpose:
# Run a build for a type determined by the name of the script invoked.
# The actual name of this script is 'mk-mkd', depending on the name of
# the symlink used to invoke it, different behavior is triggered.
#   invoking 'mk' causes a production build
#            'mkd' causes a debug build
#
# This reduces overhead and potential confusion as there 
# is only one script to maintain.
#
# Arguments:
#  Command-line arguments passed to this script are handed off to the
#  gmake invocation that executes the builder generated by the
#  cmake pass immediately prior.
#  This allows for 
#        mk[mkd] clean  -to clean the build and output trees
#                         of object, library, and executables files.
#
#        mk[mkd] cleaner  -removes all bin/lib/module files in the current
#                          project production/debug directory tree and the 
#                          upper level production/debug directory tree 
#                        
#        mk[mkd] obliterate  -removes ALL bin/lib/module files for ALL 
#                             projects in ALL production/debug directories.
#                             PLEASE USE WISELY!
#                            
# 
#---------------------------------------------------------------------------

THIS_SCRIPT=`basename $0`

# Determine which cmake is available 

if ( [ -e /usr/bin/cmake28 ] ) then 
		CMAKE_BINARY=/usr/bin/cmake28
	else
		CMAKE_BINARY=cmake
fi

# Determine if the current working directory is a buildable project
if ( [ ! -e CMakeLists.txt ] ) then
    if ( [ ! -e acc_build ] ) then
	echo -e "\nThis working directory is not a project supported by the ACC build system.\n"
	exit 1
    fi
fi

# Assign build type based on invoked name of script.
if [ ${THIS_SCRIPT} == "mk" ] 
then
  BUILD_TYPE="production"
fi

if [ ${THIS_SCRIPT} == "mkd" ]
then
  BUILD_TYPE="debug"
fi

# Just incase the gmake -j level is not set, we'll set it here, to "2".
if [ -z ${ACC_SET_GMAKE_JOBS} ] || [ "${ACC_SET_GMAKE_JOBS}" == "0" ] ; then export ACC_SET_GMAKE_JOBS=2 ; fi

# Only invoke cmake if the user has not requested a 'clean'.
if [[ ${1} == "clean" ]]
then
    if [ -d ${BUILD_TYPE} ]
    then
	cd ${BUILD_TYPE}
	gmake clean
    fi
elif [[ ${1} == "cleaner" ]]
then
    rm -rf `pwd`/${BUILD_TYPE}
    DIR=`pwd`
    rm -rf "../config/$(basename $DIR)"
    if [ -e acc_build ] ; then ./acc_build -"${BUILD_TYPE}" -cleaner ; fi
    echo -e "\nRemoved cached files.  This will force a reconfiguration upon the next build request.\n"
elif [[ ${1} == "obliterate" ]]
then
    rm -rf `pwd`/${BUILD_TYPE}
    DIR=`pwd`
    rm -rf "../config/$(basename $DIR)"
    cd ..
    rm -rf ${BUILD_TYPE}
    rm -rf `pwd`/*/${BUILD_TYPE}
    echo -e "\nRemoved "`echo ${BUILD_TYPE}`" directories in all build project directories within the current tree:\n" 
    echo -e "   "`pwd`"\n"
else
    if [ -e acc_build ]
    then
	./acc_build -"${BUILD_TYPE}" || exit 1
    else
        # If the local out-of-source build directory does not yet exist, create it.
	if ( [ ! -d ${BUILD_TYPE} ] ) then
	    mkdir ${BUILD_TYPE}
	fi
	cd ${BUILD_TYPE}
	${CMAKE_BINARY} -DCMAKE_BUILD_TYPE=${BUILD_TYPE} .. || exit 1
	gmake -j ${ACC_SET_GMAKE_JOBS} ${@}
    fi
fi
#
